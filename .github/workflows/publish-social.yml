name: Publish to Social Media

on:
  workflow_run:
    workflows: ["Build & Deploy"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      article_path:
        description: 'æ–‡ç« è·¯å¾‘ï¼ˆä¾‹: src/content/articles/xxx.mdï¼‰'
        required: false

permissions:
  contents: write
  issues: write

jobs:
  publish:
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 10

      - name: Find new articles
        id: detect
        run: |
          # æ‰‹å‹•è§¸ç™¼æ™‚ç”¨æŒ‡å®šçš„æ–‡ç« è·¯å¾‘
          if [ -n "${{ github.event.inputs.article_path }}" ]; then
            echo "articles=${{ github.event.inputs.article_path }}" >> $GITHUB_OUTPUT
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "ğŸ“ Manual trigger: ${{ github.event.inputs.article_path }}"
            exit 0
          fi

          # åªåµæ¸¬ã€Œæ–°å¢ã€çš„æ–‡ç« ï¼ˆ--diff-filter=Aï¼‰ï¼Œæ’é™¤ä¿®æ”¹/åˆªé™¤
          NEW_ARTICLES=""
          for i in $(seq 0 8); do
            DIFF=$(git diff --diff-filter=A --name-only HEAD~$((i+1)) HEAD~$i -- 'src/content/articles/*.md' 2>/dev/null | grep -v '/en/' | grep -v '/ja/' | grep -v '/zh-cn/' || true)
            if [ -n "$DIFF" ]; then
              NEW_ARTICLES="$DIFF"
              echo "ğŸ“ Found NEW article (added) in HEAD~$((i+1))..HEAD~$i"
              break
            fi
          done

          # dedup â€” æª¢æŸ¥æ˜¯å¦å·²ç¶“ç™¼ä½ˆé
          if [ -n "$NEW_ARTICLES" ] && [ -f "data/published-slugs.json" ]; then
            FILTERED=""
            for f in $NEW_ARTICLES; do
              SLUG=$(basename "$f" .md)
              if grep -q "\"$SLUG\"" data/published-slugs.json; then
                echo "â­ï¸  Already published: $SLUG"
              else
                FILTERED="$FILTERED$f"$'\n'
              fi
            done
            NEW_ARTICLES=$(echo "$FILTERED" | sed '/^$/d')
          fi

          echo "articles<<EOF" >> $GITHUB_OUTPUT
          echo "$NEW_ARTICLES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ -z "$NEW_ARTICLES" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No new articles to publish"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "ğŸ“ New articles to publish:"
            echo "$NEW_ARTICLES"
          fi

      - name: Setup Node.js
        if: steps.detect.outputs.skip == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate summaries and publish
        id: publish
        if: steps.detect.outputs.skip == 'false'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ONEUP_API_KEY: ${{ secrets.ONEUP_API_KEY }}
          ONEUP_CATEGORY_ID: ${{ secrets.ONEUP_CATEGORY_ID }}
          FREEIMAGE_API_KEY: ${{ secrets.FREEIMAGE_API_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SITE_URL: "https://paulkuo.tw"
        run: |
          node scripts/publish-social.mjs "${{ steps.detect.outputs.articles }}"

      - name: Record published slugs
        if: steps.detect.outputs.skip == 'false'
        run: |
          mkdir -p data
          if [ ! -f data/published-slugs.json ]; then
            echo '[]' > data/published-slugs.json
          fi

          ARTICLES="${{ steps.detect.outputs.articles }}"
          for f in $ARTICLES; do
            SLUG=$(basename "$f" .md)
            python3 -c "
          import json
          with open('data/published-slugs.json') as f:
              slugs = json.load(f)
          if '$SLUG' not in slugs:
              slugs.append('$SLUG')
          with open('data/published-slugs.json','w') as f:
              json.dump(slugs, f, indent=2)
          "
          done

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/published-slugs.json data/social-logs/
          git diff --staged --quiet || git commit -m "chore: record published slugs" && git push || true

      # ğŸŸ¡ FIX: GitHub Issue é€šçŸ¥ â€” æ¯æ¬¡ç™¼ä½ˆå»ºä¸€å€‹ issueï¼Œä¿¡ç®±æœƒæ”¶åˆ°
      - name: Create notification issue
        if: steps.detect.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ARTICLES="${{ steps.detect.outputs.articles }}"
          for f in $ARTICLES; do
            SLUG=$(basename "$f" .md)
            TITLE="ğŸ“¢ ç¤¾ç¾¤å·²æ’ç¨‹ï¼š$SLUG"

            # è®€å– social-log å…§å®¹
            LOG_FILE="data/social-logs/${SLUG}-$(date -u +%Y-%m-%d).json"
            if [ -f "$LOG_FILE" ]; then
              SUMMARIES=$(python3 -c "
          import json
          with open('$LOG_FILE') as f:
              data = json.load(f)
          print(f\"**æ–‡ç« ï¼š** {data['title']}\n\")
          print(f\"**é€£çµï¼š** {data['url']}\n\")
          for platform, content in data['summaries'].items():
              print(f'### {platform}\n')
              print(f'{content[:300]}\n')
          ")
            else
              SUMMARIES="Log file not found: $LOG_FILE"
            fi

            BODY="è‡ªå‹•ç¤¾ç¾¤ç™¼ä½ˆå®Œæˆã€‚ä»¥ä¸‹æ˜¯å„å¹³å°æ‘˜è¦å…§å®¹ï¼Œå¦‚æœ‰å•é¡Œè«‹åœ¨ 1 å°æ™‚å…§åˆ° [OneUp](https://app.oneupapp.io) å–æ¶ˆæ’ç¨‹ã€‚

          âš ï¸ **FBã€IG éœ€æ‰‹å‹•ç™¼ä½ˆ**

          ---

          $SUMMARIES

          ---
          _æ­¤ issue ç”± publish-social workflow è‡ªå‹•å»ºç«‹ï¼Œç¢ºèªç„¡èª¤å¯ç›´æ¥é—œé–‰ã€‚_"

            gh issue create --title "$TITLE" --body "$BODY" --label "social-publish" || true
          done
