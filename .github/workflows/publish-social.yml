name: Publish to Social Media

on:
  workflow_run:
    workflows: ["Build & Deploy"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      article_path:
        description: 'ÊñáÁ´†Ë∑ØÂæëÔºà‰æã: src/content/articles/xxx.mdÔºâ'
        required: false

jobs:
  publish:
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 10

      - name: Find new articles
        id: detect
        run: |
          # ÊâãÂãïËß∏ÁôºÊôÇÁî®ÊåáÂÆöÁöÑÊñáÁ´†Ë∑ØÂæë
          if [ -n "${{ github.event.inputs.article_path }}" ]; then
            echo "articles=${{ github.event.inputs.article_path }}" >> $GITHUB_OUTPUT
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "üìù Manual trigger: ${{ github.event.inputs.article_path }}"
            exit 0
          fi

          # Ëá™ÂãïËß∏ÁôºÔºöÊéÉÊúÄËøë 10 ÂÄã commit ÊâæÊñ∞Â¢ûÁöÑÊñáÁ´†
          NEW_ARTICLES=""
          for i in $(seq 1 9); do
            DIFF=$(git diff --name-only HEAD~$((i+1)) HEAD~$i -- 'src/content/articles/*.md' 2>/dev/null | grep -v '/en/' | grep -v '/ja/' | grep -v '/zh-cn/' || true)
            if [ -n "$DIFF" ]; then
              NEW_ARTICLES="$DIFF"
              echo "üìù Found new article in HEAD~$((i+1))..HEAD~$i"
              break
            fi
          done

          # ‰πüÊü• HEAD~1..HEAD
          LATEST=$(git diff --name-only HEAD~1 HEAD -- 'src/content/articles/*.md' 2>/dev/null | grep -v '/en/' | grep -v '/ja/' | grep -v '/zh-cn/' || true)
          if [ -n "$LATEST" ]; then
            NEW_ARTICLES="$LATEST"
          fi

          echo "articles<<EOF" >> $GITHUB_OUTPUT
          echo "$NEW_ARTICLES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ -z "$NEW_ARTICLES" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No new articles to publish"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "üìù New articles found:"
            echo "$NEW_ARTICLES"
          fi

      - name: Setup Node.js
        if: steps.detect.outputs.skip == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate summaries and publish
        if: steps.detect.outputs.skip == 'false'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ONEUP_API_KEY: ${{ secrets.ONEUP_API_KEY }}
          ONEUP_CATEGORY_ID: ${{ secrets.ONEUP_CATEGORY_ID }}
          FREEIMAGE_API_KEY: ${{ secrets.FREEIMAGE_API_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SITE_URL: "https://paulkuo.tw"
        run: |
          node scripts/publish-social.mjs "${{ steps.detect.outputs.articles }}"
