name: Publish to Social Media

on:
  # Ëá™ÂãïËß∏ÁôºÔºödeploy ÂÆåÊàêÂæåÔºåÁî¢ÊëòË¶Å + ÈÖçÂúñ ‚Üí Âª∫ Issue Á≠âÂØ©Ê†∏
  workflow_run:
    workflows: ["Build & Deploy"]
    types: [completed]
    branches: [main]
  # ÊâãÂãïËß∏ÁôºÔºöÂØ©Ê†∏ÈÄöÈÅéÂæåÔºåÈÄÅ OneUp ÊéíÁ®ã
  workflow_dispatch:
    inputs:
      slug:
        description: 'ÊñáÁ´† slugÔºà‰æã: overcome-fear-start-uglyÔºâ'
        required: true
      action:
        description: 'Âãï‰Ωú'
        required: true
        default: 'dispatch'
        type: choice
        options:
          - dispatch
          - prepare

permissions:
  contents: write
  issues: write

jobs:
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # Job 1: Ëá™ÂãïÁî¢ÊëòË¶Å + ÈÖçÂúñÔºà‰∏çÊéíÁ®ãÔºâ
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  prepare:
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'prepare')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 10

      - name: Find new articles
        id: detect
        run: |
          # ÊâãÂãïÊåáÂÆö slug ÊôÇ
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SLUG="${{ github.event.inputs.slug }}"
            FILE="src/content/articles/${SLUG}.md"
            if [ -f "$FILE" ]; then
              echo "articles=$FILE" >> $GITHUB_OUTPUT
              echo "skip=false" >> $GITHUB_OUTPUT
              echo "üìù Manual prepare: $FILE"
            else
              echo "skip=true" >> $GITHUB_OUTPUT
              echo "‚ùå File not found: $FILE"
            fi
            exit 0
          fi

          # Ëá™ÂãïÂÅµÊ∏¨Êñ∞Â¢ûÊñáÁ´†
          NEW_ARTICLES=""
          for i in $(seq 0 8); do
            DIFF=$(git diff --diff-filter=A --name-only HEAD~$((i+1)) HEAD~$i -- 'src/content/articles/*.md' 2>/dev/null | grep -v '/en/' | grep -v '/ja/' | grep -v '/zh-cn/' || true)
            if [ -n "$DIFF" ]; then
              NEW_ARTICLES="$DIFF"
              echo "üìù Found NEW article in HEAD~$((i+1))..HEAD~$i"
              break
            fi
          done

          # Ê™¢Êü•ÊòØÂê¶Â∑≤Áôº‰ΩàÈÅé
          if [ -n "$NEW_ARTICLES" ] && [ -f "data/published-slugs.json" ]; then
            FILTERED=""
            for f in $NEW_ARTICLES; do
              SLUG=$(basename "$f" .md)
              if grep -q "\"$SLUG\"" data/published-slugs.json; then
                echo "‚è≠Ô∏è  Already published: $SLUG"
              else
                FILTERED="$FILTERED$f"$'\n'
              fi
            done
            NEW_ARTICLES=$(echo "$FILTERED" | sed '/^$/d')
          fi

          echo "articles<<EOF" >> $GITHUB_OUTPUT
          echo "$NEW_ARTICLES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ -z "$NEW_ARTICLES" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No new articles"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        if: steps.detect.outputs.skip == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        if: steps.detect.outputs.skip == 'false'
        run: npm install sharp

      - name: Prepare social content
        if: steps.detect.outputs.skip == 'false'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          FREEIMAGE_API_KEY: ${{ secrets.FREEIMAGE_API_KEY }}
          SITE_URL: "https://paulkuo.tw"
        run: |
          node scripts/prepare-social.mjs "${{ steps.detect.outputs.articles }}"

      - name: Commit social logs
        if: steps.detect.outputs.skip == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/social-logs/ data/costs.jsonl
          git diff --staged --quiet || git commit -m "chore: prepare social content [skip-translate]" && git push || true

      - name: Create review Issue
        if: steps.detect.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ARTICLES="${{ steps.detect.outputs.articles }}"
          for f in $ARTICLES; do
            SLUG=$(basename "$f" .md)
            TITLE="üìã Á§æÁæ§ÊëòË¶ÅÂæÖÂØ©Ê†∏Ôºö$SLUG"
            TODAY=$(date -u +%Y-%m-%d)
            LOG_FILE="data/social-logs/${SLUG}-${TODAY}.json"

            if [ -f "$LOG_FILE" ]; then
              SUMMARIES=$(python3 -c "
          import json
          with open('$LOG_FILE') as f:
              data = json.load(f)
          print(f\"**ÊñáÁ´†Ôºö** {data['title']}\n\")
          print(f\"**ÈÄ£ÁµêÔºö** {data['url']}\n\")
          if data.get('imageUrl'):
              print(f\"**ÈÖçÂúñÔºö** ![]({data['imageUrl']})\n\")
          for platform, content in data['summaries'].items():
              print(f'### {platform}\n')
              print(f'{content[:500]}\n')
          ")
            else
              SUMMARIES="‚ö†Ô∏è Log file not found: $LOG_FILE"
            fi

            BODY="Ëá™ÂãïÁî¢ÁîüÁöÑÁ§æÁæ§ÊëòË¶ÅÔºå**Ë´ãÂØ©Ê†∏ÂæåÊâãÂãïËß∏ÁôºÁôº‰Ωà**„ÄÇ

          ## ÂØ©Ê†∏Ê≠•È©ü
          1. Ê™¢Êü•‰ª•‰∏ãÂêÑÂπ≥Âè∞ÊëòË¶ÅÂÖßÂÆπ
          2. Á¢∫Ë™ç OK ‚Üí Âà∞ [Actions](https://github.com/zarqarwi/paulkuo.tw/actions/workflows/publish-social.yml) ÊâãÂãïËß∏Áôº dispatch
             - slug: \`$SLUG\`
             - action: \`dispatch\`
          3. ÊàñÂú®Ê≠§ Issue ÁïôË®Ä‰øÆÊîπÈúÄÊ±Ç

          ---

          $SUMMARIES

          ---
          _Ê≠§ issue Áî± prepare-social workflow Ëá™ÂãïÂª∫Á´ã„ÄÇÂØ©Ê†∏ÈÄöÈÅéÂæåË´ãÊâãÂãï dispatch„ÄÇ_"

            gh issue create --title "$TITLE" --body "$BODY" --label "social-review" || true
          done

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # Job 2: ÊâãÂãïËß∏Áôº ‚Äî ÈÄÅ OneUp ÊéíÁ®ã
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  dispatch:
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.action == 'dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Dispatch to OneUp
        env:
          ONEUP_API_KEY: ${{ secrets.ONEUP_API_KEY }}
          ONEUP_CATEGORY_ID: ${{ secrets.ONEUP_CATEGORY_ID }}
        run: |
          node scripts/dispatch-social.mjs "${{ github.event.inputs.slug }}"

      - name: Commit dispatch status
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/social-logs/ data/published-slugs.json
          git diff --staged --quiet || git commit -m "chore: dispatched social posts for ${{ github.event.inputs.slug }} [skip-translate]" && git push || true
