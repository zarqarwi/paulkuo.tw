---
/**
 * BlogPage.astro — 共用 blog 列表元件
 * 接受語系參數，渲染對應 collection 的文章
 */
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import { PILLAR_MAP, SITE } from '../config';
import { LANGUAGES, type LangKey } from '../i18n';
import { calcReadingTime } from '../utils/readingTime';

interface Props {
  lang: LangKey;
}

const { lang } = Astro.props;
const L = LANGUAGES[lang];
const ARTICLES_PER_PAGE = 12;

const articles = (await getCollection(L.collectionName, ({ data }) => !data.draft))
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const pillars = Object.entries(PILLAR_MAP);

// Extract unique years from articles, sorted descending
const years = [...new Set(articles.map(a => a.data.date.getFullYear()))].sort((a, b) => b - a);
const basePath = L.pathPrefix || '';

const blogSchema = JSON.stringify({
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "CollectionPage",
      "@id": `${SITE.url}${basePath}/blog#page`,
      "name": L.blogTitle,
      "description": L.blogDesc,
      "url": `${SITE.url}${basePath}/blog`,
      "inLanguage": L.code,
      "isPartOf": { "@id": `${SITE.url}/#website` },
      "author": { "@id": `${SITE.url}/#person` },
      "mainEntity": { "@id": `${SITE.url}${basePath}/blog#list` }
    },
    {
      "@type": "ItemList",
      "@id": `${SITE.url}${basePath}/blog#list`,
      "name": L.blogTitle,
      "numberOfItems": articles.length,
      "itemListElement": articles.slice(0, 30).map((article, idx) => ({
        "@type": "ListItem",
        "position": idx + 1,
        "url": `${SITE.url}${basePath}/articles/${article.id.replace(/\.md$/, '')}`,
        "name": article.data.title
      }))
    }
  ]
});
---

<BaseLayout title={`${L.blogTitle} — Paul Kuo`} description={L.blogDesc} schemaJson={blogSchema}>
  <div class="section-container">
    <div class="blog-hero">
      <h1>{L.blogTitle}</h1>
      <p>{L.blogDesc}</p>
      <a href="/tags" class="tags-link">{lang === 'en' ? 'Browse Tags →' : lang === 'ja' ? 'タグ一覧 →' : '瀏覽標籤 →'}</a>
    </div>

    <div class="blog-filters">
      <button class="filter-btn active" data-filter="all">{L.allFilter}</button>
      {pillars.map(([key, p]) => (
        <button class="filter-btn" data-filter={key}>
          {lang === 'en' ? p.labelEn : p.label}
        </button>
      ))}
    </div>

    <div class="blog-year-filters">
      <button class="year-btn active" data-year="all">{lang === 'en' ? 'All Years' : lang === 'ja' ? '\u5168\u5e74' : '\u6240\u6709\u5e74\u4efd'}</button>
      {years.map(y => (
        <button class="year-btn" data-year={y.toString()}>{y}</button>
      ))}
    </div>

    <h2 class="sr-only">{lang === 'en' ? 'Articles' : lang === 'ja' ? '記事一覧' : '文章列表'}</h2>

    <div class="content-grid" id="blog-grid">
      {articles.map((article, idx) => {
        const p = PILLAR_MAP[article.data.pillar];
        const isoDate = article.data.date.toISOString().split('T')[0];
        const dateStr = article.data.date.toLocaleDateString(L.dateLocale, L.dateOptions);
        return (
          <a href={`${basePath}/articles/${article.id.replace(/\.md$/, "")}`}
             class={`content-card ${article.data.cover ? 'has-cover' : ''} ${idx >= ARTICLES_PER_PAGE ? 'hidden-card' : ''}`}
             data-pillar={article.data.pillar} data-year={article.data.date.getFullYear().toString()}>
            {article.data.cover && (
              <div class="card-cover">
                <img src={article.data.cover} alt={article.data.title} loading="lazy" />
              </div>
            )}
            <div class="content-card-category" style={`color:${p.color}`}>
              <span class="pillar-dot" style={`background:${p.color}`}></span>
              {lang === 'en' ? p.labelEn : p.label}
            </div>
            <h3>{article.data.title}</h3>
            <p class="card-excerpt">{article.data.description}</p>
            <div class="content-card-footer">
              <time datetime={isoDate}>{dateStr}</time>
              {(() => { const rt = calcReadingTime(article.body || ''); return rt > 0 ? <span class="reading-time">· {lang === 'en' ? `${rt} min` : lang === 'ja' ? `約${rt}分` : `約 ${rt} 分鐘`}</span> : null; })()}
              {article.data.platform && <span class="platform-badge">{article.data.platform}</span>}
            </div>
          </a>
        );
      })}
    </div>

    {articles.length > ARTICLES_PER_PAGE && (
      <div class="load-more-wrap" id="load-more-wrap">
        <button class="load-more-btn" id="load-more-btn">
          {L.showMore} <span id="remaining-count"></span>
        </button>
      </div>
    )}

    {articles.length === 0 && (
      <div style="text-align:center; padding:80px 0; color:var(--text-muted);">
        <p>{L.noArticles}</p>
      </div>
    )}
  </div>

  <script define:vars={{ ARTICLES_PER_PAGE }}>
    let visibleCount = ARTICLES_PER_PAGE;
    const allCards = Array.from(document.querySelectorAll('#blog-grid .content-card'));
    const loadMoreBtn = document.getElementById('load-more-btn');
    const loadMoreWrap = document.getElementById('load-more-wrap');
    const remainingSpan = document.getElementById('remaining-count');

    function getFilteredCards() {
      const activeFilter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';
      const activeYear = document.querySelector('.year-btn.active')?.dataset.year || 'all';
      return allCards.filter(c => {
        const pillarMatch = activeFilter === 'all' || c.dataset.pillar === activeFilter;
        const yearMatch = activeYear === 'all' || c.dataset.year === activeYear;
        return pillarMatch && yearMatch;
      });
    }

    function updateVisibility() {
      const activeFilter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';
      const activeYear = document.querySelector('.year-btn.active')?.dataset.year || 'all';
      let shown = 0;
      allCards.forEach(card => {
        const pillarMatch = activeFilter === 'all' || card.dataset.pillar === activeFilter;
        const yearMatch = activeYear === 'all' || card.dataset.year === activeYear;
        if (pillarMatch && yearMatch) {
          card.style.display = shown < visibleCount ? 'block' : 'none';
          card.classList.toggle('hidden-card', shown >= visibleCount);
          shown++;
        } else {
          card.style.display = 'none';
        }
      });
      const totalFiltered = allCards.filter(c => {
        const pM = activeFilter === 'all' || c.dataset.pillar === activeFilter;
        const yM = activeYear === 'all' || c.dataset.year === activeYear;
        return pM && yM;
      }).length;
      const remaining = totalFiltered - visibleCount;
      if (loadMoreWrap) loadMoreWrap.style.display = remaining > 0 ? 'block' : 'none';
      if (remainingSpan) remainingSpan.textContent = remaining > 0 ? `(${remaining})` : '';
    }

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        visibleCount = ARTICLES_PER_PAGE;
        updateVisibility();
      });
    });

    if (loadMoreBtn) {
      loadMoreBtn.addEventListener('click', () => {
        visibleCount += ARTICLES_PER_PAGE;
        updateVisibility();
      });
    }

    
    // Year filter buttons
    document.querySelectorAll('.year-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.year-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        visibleCount = ARTICLES_PER_PAGE;
        updateVisibility();
      });
    });

    // Auto-filter from URL hash (e.g. /blog#ai, /blog#circular)
    const hash = window.location.hash.replace('#', '');
    if (hash) {
      const targetBtn = document.querySelector(`.filter-btn[data-filter="${hash}"]`);
      if (targetBtn) targetBtn.click();
    }

    updateVisibility();
  </script>
</BaseLayout>
