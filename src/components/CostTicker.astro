---
/**
 * CostTicker.astro — 首頁 API 費用 ticker bar
 * Apple Stocks widget 風格：迷你折線圖 + 數字
 */
import { readFileSync, existsSync } from 'fs';
import { join } from 'path';

const costsPath = join(process.cwd(), 'data', 'costs.jsonl');
let records: any[] = [];
if (existsSync(costsPath)) {
  records = readFileSync(costsPath, 'utf-8')
    .split('\n').filter(Boolean)
    .map(line => { try { return JSON.parse(line); } catch { return null; } })
    .filter(Boolean);
}

// Aggregate data at build time
const totalUSD = records.reduce((s, r) => s + (r.costUSD || 0), 0);
const thisMonth = new Date().toISOString().slice(0, 7);
const monthRecords = records.filter(r => r.timestamp?.startsWith(thisMonth));
const monthUSD = monthRecords.reduce((s, r) => s + (r.costUSD || 0), 0);

// Daily totals (last 14 days for sparkline)
const dailyMap: Record<string, number> = {};
records.forEach(r => {
  const d = r.timestamp?.slice(0, 10);
  if (d) dailyMap[d] = (dailyMap[d] || 0) + r.costUSD;
});
const sortedDays = Object.keys(dailyMap).sort().slice(-14);
const dailyValues = sortedDays.map(d => dailyMap[d]);
const avgPerDay = dailyValues.length > 0 ? dailyValues.reduce((a,b)=>a+b,0) / dailyValues.length : 0;

// By service
const byService: Record<string, number> = {};
records.forEach(r => { if (r.service) byService[r.service] = (byService[r.service] || 0) + r.costUSD; });

// Token totals
const totalTokens = records.reduce((s, r) => s + (r.inputTokens || 0) + (r.outputTokens || 0), 0);

// 7-day change
const last7 = sortedDays.slice(-7);
const prev7 = sortedDays.slice(-14, -7);
const last7Total = last7.reduce((s, d) => s + (dailyMap[d] || 0), 0);
const prev7Total = prev7.reduce((s, d) => s + (dailyMap[d] || 0), 0);
const changePercent = prev7Total > 0 ? ((last7Total - prev7Total) / prev7Total * 100) : 0;

const hasData = records.length > 0;

// Pass to client
const tickerData = JSON.stringify({
  totalUSD, monthUSD, avgPerDay, totalCalls: records.length,
  totalTokens, changePercent, dailyValues,
  byService, hasData,
});
---

<a href="/#feed" class="cost-ticker" id="costTicker" data-ticker={tickerData} style="text-decoration:none;color:inherit;display:block">
  {hasData ? (
    <div class="ticker-inner">
      <!-- 本月費用 + sparkline -->
      <div class="ticker-item ticker-primary">
        <span class="ticker-label">本月 API</span>
        <span class="ticker-value">${monthUSD.toFixed(2)}</span>
        <span class="ticker-sub">NT${(monthUSD * 32.5).toFixed(0)}</span>
        <canvas class="ticker-spark" id="tickerSpark" width="80" height="28"></canvas>
        <span class={`ticker-change ${changePercent >= 0 ? 'up' : 'down'}`}>
          {changePercent >= 0 ? '▲' : '▼'} {Math.abs(changePercent).toFixed(0)}%
        </span>
      </div>
      <div class="ticker-sep"></div>
      <!-- 日均 -->
      <div class="ticker-item">
        <span class="ticker-label">日均</span>
        <span class="ticker-value">${avgPerDay.toFixed(3)}</span>
      </div>
      <div class="ticker-sep"></div>
      <!-- API calls -->
      <div class="ticker-item">
        <span class="ticker-label">API 呼叫</span>
        <span class="ticker-value">{records.length.toLocaleString()}</span>
      </div>
      <div class="ticker-sep"></div>
      <!-- Token -->
      <div class="ticker-item">
        <span class="ticker-label">Token</span>
        <span class="ticker-value">{(totalTokens / 1000).toFixed(0)}K</span>
      </div>
      <div class="ticker-sep"></div>
      <!-- 累計 -->
      <div class="ticker-item">
        <span class="ticker-label">累計</span>
        <span class="ticker-value">${totalUSD.toFixed(2)}</span>
      </div>
    </div>
  ) : (
    <div class="ticker-inner ticker-empty">
      <span class="ticker-label">⚡ 自動化管線運行中</span>
      <span class="ticker-value" style="opacity:0.5">待收集數據</span>
    </div>
  )}
</a>

<script is:inline>
(function() {
  const ticker = document.getElementById('costTicker');
  if (!ticker) return;
  const data = JSON.parse(ticker.dataset.ticker || '{}');
  if (!data.hasData) return;

  // Draw sparkline
  const canvas = document.getElementById('tickerSpark');
  if (!canvas || !data.dailyValues || data.dailyValues.length < 2) return;
  const ctx = canvas.getContext('2d');
  const vals = data.dailyValues;
  const w = canvas.width, h = canvas.height;
  const max = Math.max(...vals), min = Math.min(...vals);
  const range = max - min || 1;
  const pad = 3;

  ctx.clearRect(0, 0, w, h);

  // Gradient fill
  const grad = ctx.createLinearGradient(0, 0, 0, h);
  const isUp = vals[vals.length-1] >= vals[0];
  const color = isUp ? '#059669' : '#DC2626';
  grad.addColorStop(0, isUp ? 'rgba(5,150,105,0.2)' : 'rgba(220,38,38,0.15)');
  grad.addColorStop(1, 'rgba(255,255,255,0)');

  // Fill area
  ctx.beginPath();
  vals.forEach((v, i) => {
    const x = pad + (i / (vals.length - 1)) * (w - pad * 2);
    const y = pad + (1 - (v - min) / range) * (h - pad * 2);
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.lineTo(w - pad, h); ctx.lineTo(pad, h); ctx.closePath();
  ctx.fillStyle = grad; ctx.fill();

  // Line
  ctx.beginPath();
  vals.forEach((v, i) => {
    const x = pad + (i / (vals.length - 1)) * (w - pad * 2);
    const y = pad + (1 - (v - min) / range) * (h - pad * 2);
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.strokeStyle = color; ctx.lineWidth = 1.5; ctx.stroke();

})();
</script>

<style>
  .cost-ticker {
    background: var(--brand-navy);
    color: rgba(255,255,255,0.9);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  .ticker-inner {
    max-width: var(--max-width);
    margin: 0 auto;
    display: flex;
    align-items: center;
    gap: 0;
    padding: 0 24px;
    height: 48px;
    white-space: nowrap;
    font-family: var(--font-body);
  }
  .ticker-empty {
    justify-content: center;
    gap: 12px;
  }
  .ticker-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 0 16px;
    flex-shrink: 0;
  }
  .ticker-primary {
    gap: 8px;
  }
  .ticker-label {
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: rgba(255,255,255,0.5);
    font-weight: 500;
  }
  .ticker-value {
    font-size: 0.9rem;
    font-weight: 700;
    letter-spacing: -0.02em;
  }
  .ticker-sub {
    font-size: 0.7rem;
    color: rgba(255,255,255,0.4);
  }
  .ticker-spark {
    vertical-align: middle;
    margin: 0 2px;
  }
  .ticker-change {
    font-size: 0.65rem;
    font-weight: 600;
    padding: 1px 5px;
    border-radius: 3px;
  }
  .ticker-change.up {
    color: #34d399;
    background: rgba(16,185,129,0.15);
  }
  .ticker-change.down {
    color: #fca5a5;
    background: rgba(220,38,38,0.15);
  }
  .ticker-sep {
    width: 1px;
    height: 20px;
    background: rgba(255,255,255,0.12);
    flex-shrink: 0;
  }
  @media (max-width: 768px) {
    .ticker-inner {
      padding: 0 12px;
      height: 44px;
    }
    .ticker-item { padding: 0 10px; }
  }
</style>
