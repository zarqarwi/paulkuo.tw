---
/**
 * ArticlePage.astro â€” å…±ç”¨æ–‡ç« è©³æƒ…å…ƒä»¶
 * AIO-optimized: Enhanced JSON-LD, semantic HTML, breadcrumbs
 * v2: Added prev/next nav, related articles, author card, share buttons
 */
import { render, getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import { PILLAR_MAP, SITE } from '../config';
import { LANGUAGES, type LangKey } from '../i18n';
import { getArticleEntities } from '../utils/entities';

interface Props {
  article: any;
  lang: LangKey;
}

const { article, lang } = Astro.props;
const L = LANGUAGES[lang];
const basePath = L.pathPrefix || '';
const { Content } = await render(article);
const { title, subtitle, description, abstract, date, updated, pillar, tags, readingTime } = article.data;
const p = PILLAR_MAP[pillar];
const dateStr = date.toLocaleDateString(L.dateLocale, L.dateOptions);
const slug = article.id.replace(/\.md$/, '');
const articleUrl = `${SITE.url}${basePath}/articles/${slug}`;
const ogImageUrl = `${SITE.url}/og/${slug}.png`;
const pillarLabel = lang === 'en' ? p.labelEn : p.label;

// === Related articles & prev/next navigation ===
const allArticles = (await getCollection(L.collectionName, ({ data }) => !data.draft))
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const currentSlug = article.id.replace(/\.md$/, '');
const currentIndex = allArticles.findIndex(a => a.id === article.id);

// Prev = older (next index), Next = newer (prev index)
const prevArticle = currentIndex < allArticles.length - 1 ? allArticles[currentIndex + 1] : null;
const nextArticle = currentIndex > 0 ? allArticles[currentIndex - 1] : null;

// Same-pillar related articles (exclude self), max 3
const relatedArticles = allArticles
  .filter(a => a.data.pillar === pillar && a.id.replace(/\.md$/, '') !== currentSlug)
  .slice(0, 3);

// Estimate word count from raw body (for schema)
const rawBody = article.body || '';
const wordCount = rawBody.length > 0
  ? (lang === 'en'
    ? rawBody.split(/\s+/).length
    : Math.ceil(rawBody.replace(/\s+/g, '').length / 1.5))  // CJK approximation
  : undefined;

// Entity linking: auto-detect mentioned entities from tags + body
const articleEntities = getArticleEntities(tags || [], rawBody, pillar);

const schemaJson = JSON.stringify({
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "BlogPosting",
      "@id": `${articleUrl}#article`,
      "headline": title,
      "description": description,
      "abstract": abstract || description,
      "datePublished": date.toISOString().split('T')[0],
      "dateModified": (updated || date).toISOString().split('T')[0],
      "inLanguage": L.code,
      "url": articleUrl,
      "mainEntityOfPage": { "@id": articleUrl },
      "author": { "@id": `${SITE.url}/#person` },
      "publisher": { "@id": `${SITE.url}/#person` },
      "isPartOf": { "@id": `${SITE.url}/#website` },
      "articleSection": pillarLabel,
      "about": {
        "@type": "DefinedTerm",
        "name": pillarLabel,
        "inDefinedTermSet": {
          "@type": "DefinedTermSet",
          "name": "Paul Kuo Content Pillars",
          "url": `${SITE.url}/blog`
        }
      },
      "keywords": tags,
      ...(wordCount && { "wordCount": wordCount }),
      ...(readingTime && { "timeRequired": `PT${readingTime}M` }),
      "image": ogImageUrl,
      ...(articleEntities.length > 0 && {
        "mentions": articleEntities.map(e => ({
          "@type": e['@type'],
          "name": e.name,
          ...(e.url && { "url": e.url }),
          ...(e.sameAs && { "sameAs": e.sameAs }),
          ...(e.description && { "description": e.description }),
        }))
      })
    },
    {
      "@type": "BreadcrumbList",
      "@id": `${articleUrl}#breadcrumb`,
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": lang === 'en' ? "Home" : "é¦–é ",
          "item": `${SITE.url}${basePath}/`
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": lang === 'en' ? "Articles" : "æ€æƒ³",
          "item": `${SITE.url}${basePath}/blog`
        },
        {
          "@type": "ListItem",
          "position": 3,
          "name": pillarLabel,
        },
        {
          "@type": "ListItem",
          "position": 4,
          "name": title,
          "item": articleUrl
        }
      ]
    }
  ]
});

// Canonical URL for this specific language version
const canonicalUrl = articleUrl;

// i18n labels
const i = {
  prev: lang === 'en' ? 'Previous' : lang === 'ja' ? 'å‰ã®è¨˜äº‹' : 'ä¸Šä¸€ç¯‡',
  next: lang === 'en' ? 'Next' : lang === 'ja' ? 'æ¬¡ã®è¨˜äº‹' : 'ä¸‹ä¸€ç¯‡',
  related: lang === 'en' ? 'Related Articles' : lang === 'ja' ? 'é–¢é€£è¨˜äº‹' : 'å»¶ä¼¸é–±è®€',
  share: lang === 'en' ? 'Share' : lang === 'ja' ? 'ã‚·ã‚§ã‚¢' : 'åˆ†äº«',
  backToAll: lang === 'en' ? 'All articles' : lang === 'ja' ? 'è¨˜äº‹ä¸€è¦§ã¸' : 'æ‰€æœ‰æ–‡ç« ',
  authorBio: lang === 'en'
    ? 'Rebuilding order at the intersection of technology and civilization.'
    : lang === 'ja'
    ? 'æŠ€è¡“ã¨æ–‡æ˜ã®äº¤å·®ç‚¹ã§ç§©åºã‚’å†æ§‹ç¯‰ã™ã‚‹ã€‚'
    : 'åœ¨æŠ€è¡“èˆ‡æ–‡æ˜çš„äº¤åŒ¯è™•ï¼Œé‡å»ºç§©åºã€‚',
};
---

<BaseLayout
  title={`${title} â€” Paul Kuo`}
  description={description}
  ogType="article"
  ogUrl={articleUrl}
  ogImage={ogImageUrl}
  schemaJson={schemaJson}
  canonicalUrl={canonicalUrl}>

  <article class="article-page" itemscope itemtype="https://schema.org/BlogPosting">
    <nav class="article-breadcrumb" aria-label="breadcrumb">
      <ol>
        <li><a href={`${basePath}/`}>{lang === 'en' ? 'Home' : 'é¦–é '}</a></li>
        <li><a href={`${basePath}/blog`}>{lang === 'en' ? 'Articles' : 'æ€æƒ³'}</a></li>
        <li aria-current="page">{title}</li>
      </ol>
    </nav>

    <header class="article-meta">
      <div class="article-pillar" style={`color:${p.color}`}>
        <span class="pillar-dot" style={`background:${p.color}`}></span>
        <span itemprop="articleSection">{pillarLabel}</span>
      </div>
      <h1 itemprop="headline">{title}</h1>
      {subtitle && <p class="article-subtitle" itemprop="alternativeHeadline">{subtitle}</p>}
      <div class="article-info">
        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
          <span itemprop="name">{SITE.author}</span> <span itemprop="alternateName">{SITE.authorAlt}</span>
        </span>
        <time datetime={date.toISOString().split('T')[0]} itemprop="datePublished">{dateStr}</time>
        {updated && <meta itemprop="dateModified" content={(updated).toISOString().split('T')[0]} />}
        {readingTime && <span>{L.readingTime(readingTime)}</span>}
      </div>
      <meta itemprop="description" content={description} />
    </header>

    <section class="article-body" itemprop="articleBody" aria-label={lang === 'en' ? 'Article content' : 'æ–‡ç« å…§å®¹'}>
      <Content />
    </section>

    {tags.length > 0 && (
      <footer class="article-tags" aria-label={lang === 'en' ? 'Tags' : 'æ¨™ç±¤'}>
        {tags.map(tag => <span class="article-tag" itemprop="keywords">{tag}</span>)}
      </footer>
    )}

    {/* === Author Card === */}
    <div class="author-card">
      <img src="/paul-photo.png" alt="Paul Kuo" class="author-avatar" width="64" height="64" loading="lazy" />
      <div class="author-info">
        <strong>Paul Kuo éƒ­æ›œéƒ</strong>
        <p>{i.authorBio}</p>
      </div>
    </div>

    {/* === Share Buttons === */}
    <div class="share-buttons">
      <span class="share-label">{i.share}</span>
      <a href={`https://twitter.com/intent/tweet?url=${encodeURIComponent(articleUrl)}&text=${encodeURIComponent(title)}`}
         target="_blank" rel="noopener" class="share-btn" aria-label="Share on X">ğ•</a>
      <a href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(articleUrl)}`}
         target="_blank" rel="noopener" class="share-btn" aria-label="Share on LinkedIn">in</a>
      <a href={`https://www.threads.net/intent/post?text=${encodeURIComponent(title + ' ' + articleUrl)}`}
         target="_blank" rel="noopener" class="share-btn" aria-label="Share on Threads">â—‰</a>
    </div>

    {/* === Prev / Next Navigation === */}
    <nav class="article-nav" aria-label={lang === 'en' ? 'Article navigation' : 'æ–‡ç« å°èˆª'}>
      {prevArticle ? (
        <a href={`${basePath}/articles/${prevArticle.id.replace(/\.md$/, '')}`} class="article-nav-link prev">
          <span class="nav-label">â† {i.prev}</span>
          <span class="nav-title">{prevArticle.data.title}</span>
        </a>
      ) : <div />}
      {nextArticle ? (
        <a href={`${basePath}/articles/${nextArticle.id.replace(/\.md$/, '')}`} class="article-nav-link next">
          <span class="nav-label">{i.next} â†’</span>
          <span class="nav-title">{nextArticle.data.title}</span>
        </a>
      ) : <div />}
    </nav>

    {/* === Related Articles === */}
    {relatedArticles.length > 0 && (
      <section class="related-articles" aria-label={i.related}>
        <h2>{i.related}</h2>
        <div class="related-grid">
          {relatedArticles.map(ra => {
            const rp = PILLAR_MAP[ra.data.pillar];
            return (
              <a href={`${basePath}/articles/${ra.id.replace(/\.md$/, '')}`} class="related-card">
                <span class="related-pillar" style={`color:${rp.color}`}>
                  <span class="pillar-dot" style={`background:${rp.color}`}></span>
                  {lang === 'en' ? rp.labelEn : rp.label}
                </span>
                <h3>{ra.data.title}</h3>
                <time>{ra.data.date.toLocaleDateString(L.dateLocale, L.dateOptions)}</time>
              </a>
            );
          })}
        </div>
      </section>
    )}

    {/* === Back to Blog CTA === */}
    <div class="article-back">
      <a href={`${basePath}/blog`} class="back-to-blog">â† {i.backToAll}</a>
    </div>
  </article>
</BaseLayout>
