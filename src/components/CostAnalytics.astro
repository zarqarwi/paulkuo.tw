---
/**
 * CostAnalytics.astro — 消息頁上方的費用分析區塊
 * 完整圖表：每日趨勢、服務商分佈、來源分佈、動作類型
 */
import { readFileSync, existsSync } from 'fs';
import { join } from 'path';

const costsPath = join(process.cwd(), 'data', 'costs.jsonl');
let records: any[] = [];
if (existsSync(costsPath)) {
  records = readFileSync(costsPath, 'utf-8')
    .split('\n').filter(Boolean)
    .map(line => { try { return JSON.parse(line); } catch { return null; } })
    .filter(Boolean);
}

const hasData = records.length > 0;
const analyticsData = JSON.stringify(records);
---

{hasData && (
<div class="cost-analytics" id="costAnalytics">
  <div class="analytics-header">
    <div>
      <h3 class="analytics-title">自動化管線運營</h3>
      <p class="analytics-subtitle">API 費用追蹤 · 辯論引擎 × 翻譯 × 社群發佈</p>
    </div>
    <a href="/dashboard" class="analytics-link">完整儀表板 →</a>
  </div>

  <div class="analytics-kpis" id="analyticsKpis"></div>

  <div class="analytics-charts">
    <div class="analytics-chart-main">
      <canvas id="analyticsDailyChart"></canvas>
    </div>
    <div class="analytics-chart-side">
      <div class="analytics-chart-half">
        <canvas id="analyticsServiceChart"></canvas>
      </div>
      <div class="analytics-chart-half">
        <canvas id="analyticsActionChart"></canvas>
      </div>
    </div>
  </div>
</div>
)}

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js" is:inline></script>
<script define:vars={{ analyticsData, hasData }} is:inline>
(function() {
  if (!hasData) return;
  const records = JSON.parse(analyticsData);
  if (!records.length) return;

  const SVC_CLR = { anthropic:'#6366f1', openai:'#10b981', google:'#3b82f6', xai:'#f97316', perplexity:'#8b5cf6' };
  const SRC_CLR = { 'debate-engine':'#f59e0b', 'translate-article':'#3b82f6', 'publish-social':'#ec4899', 'debate-to-article':'#06b6d4' };
  const ACT_CLR = { debate:'#f59e0b', 'translate-en':'#3b82f6', 'translate-ja':'#60a5fa', 'translate-zh-cn':'#93c5fd',
    'social-summary':'#ec4899', 'image-gen':'#10b981', 'debate-to-article':'#06b6d4', factcheck:'#8b5cf6' };
  const ACT_LABEL = { debate:'辯論', 'translate-en':'EN', 'translate-ja':'JA', 'translate-zh-cn':'簡中',
    'social-summary':'摘要', 'image-gen':'配圖', 'debate-to-article':'轉文章', factcheck:'查核' };

  const totalUSD = records.reduce((s,r) => s + r.costUSD, 0);
  const thisMonth = new Date().toISOString().slice(0,7);
  const monthUSD = records.filter(r => r.timestamp.startsWith(thisMonth)).reduce((s,r) => s + r.costUSD, 0);
  const days = [...new Set(records.map(r => r.timestamp.slice(0,10)))].sort();
  const avgPerDay = totalUSD / (days.length || 1);
  const totalTokens = records.reduce((s,r) => s + (r.inputTokens||0) + (r.outputTokens||0), 0);

  // KPIs
  document.getElementById('analyticsKpis').innerHTML = `
    <div class="ak"><span class="ak-v" style="color:var(--brand-navy)">$${monthUSD.toFixed(2)}</span><span class="ak-l">本月費用</span></div>
    <div class="ak"><span class="ak-v" style="color:var(--accent-circular)">$${avgPerDay.toFixed(3)}</span><span class="ak-l">日均</span></div>
    <div class="ak"><span class="ak-v" style="color:var(--accent-ai)">${records.length}</span><span class="ak-l">API 呼叫</span></div>
    <div class="ak"><span class="ak-v" style="color:var(--accent-life)">${(totalTokens/1000).toFixed(0)}K</span><span class="ak-l">Token</span></div>
  `;

  const chartFont = { family: "'DM Sans', sans-serif" };
  const gridColor = '#E8E6E1';

  // Daily stacked bar (last 30 days)
  const last30 = days.slice(-30);
  const sources = [...new Set(records.map(r => r.source))];
  const dailyData = {}; last30.forEach(d => { dailyData[d] = {}; sources.forEach(s => dailyData[d][s] = 0); });
  records.forEach(r => { const d = r.timestamp.slice(0,10); if (dailyData[d]) dailyData[d][r.source] += r.costUSD; });
  new Chart(document.getElementById('analyticsDailyChart'), {
    type: 'bar',
    data: { labels: last30.map(d => d.slice(5)),
      datasets: sources.map(s => ({ label: s, data: last30.map(d => +(dailyData[d][s]||0).toFixed(4)),
        backgroundColor: SRC_CLR[s] || '#8A8A8A', borderRadius: 2 })) },
    options: { responsive:true, maintainAspectRatio:false,
      scales: { x:{stacked:true,grid:{display:false},ticks:{color:'#8A8A8A',font:{...chartFont,size:9},maxRotation:0,autoSkip:true,maxTicksLimit:10}},
        y:{stacked:true,grid:{color:gridColor},ticks:{color:'#8A8A8A',font:{...chartFont,size:9},callback:v=>'$'+v.toFixed(2)}} },
      plugins: { legend:{position:'bottom',labels:{color:'#5A5A5A',font:{...chartFont,size:10},padding:8,boxWidth:10}},
        tooltip:{callbacks:{label:ctx=>`${ctx.dataset.label}: $${ctx.raw.toFixed(4)}`}} } },
  });

  // Service doughnut
  const bySvc = {}; records.forEach(r => { bySvc[r.service] = (bySvc[r.service]||0) + r.costUSD; });
  const sk = Object.keys(bySvc).sort((a,b) => bySvc[b]-bySvc[a]);
  new Chart(document.getElementById('analyticsServiceChart'), {
    type: 'doughnut',
    data: { labels: sk, datasets: [{ data: sk.map(k => +bySvc[k].toFixed(4)),
      backgroundColor: sk.map(k => SVC_CLR[k]||'#8A8A8A'), borderWidth: 2, borderColor: '#FFFFFF' }] },
    options: { responsive:true, maintainAspectRatio:false, cutout:'55%',
      plugins: { legend:{position:'bottom',labels:{color:'#5A5A5A',font:{...chartFont,size:10},padding:6,boxWidth:10}},
        tooltip:{callbacks:{label:ctx=>`${ctx.label}: $${ctx.raw.toFixed(4)}`}} } },
  });

  // Action horizontal bar
  const byAct = {}; records.forEach(r => { byAct[r.action] = (byAct[r.action]||0) + r.costUSD; });
  const ak = Object.keys(byAct).sort((a,b) => byAct[b]-byAct[a]).slice(0, 6);
  new Chart(document.getElementById('analyticsActionChart'), {
    type: 'bar',
    data: { labels: ak.map(k => ACT_LABEL[k]||k),
      datasets: [{ data: ak.map(k => +byAct[k].toFixed(4)),
        backgroundColor: ak.map(k => ACT_CLR[k]||'#8A8A8A'), borderRadius: 3 }] },
    options: { responsive:true, maintainAspectRatio:false, indexAxis:'y',
      scales: { x:{grid:{color:gridColor},ticks:{color:'#8A8A8A',font:{...chartFont,size:9},callback:v=>'$'+v.toFixed(2)}},
        y:{grid:{display:false},ticks:{color:'#5A5A5A',font:{...chartFont,size:10}}} },
      plugins: { legend:{display:false} } },
  });
})();
</script>

<style>
  .cost-analytics {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 2rem;
    margin-bottom: 2.5rem;
    box-shadow: var(--shadow-sm);
  }
  .analytics-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.25rem;
  }
  .analytics-title {
    font-family: var(--font-display);
    font-size: 1.25rem;
    color: var(--brand-navy);
    margin: 0;
  }
  .analytics-subtitle {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: 2px;
  }
  .analytics-link {
    font-size: 0.8rem;
    color: var(--accent-ai);
    text-decoration: none;
    font-weight: 500;
    white-space: nowrap;
  }
  .analytics-link:hover { text-decoration: underline; }

  .analytics-kpis {
    display: flex;
    gap: 2rem;
    margin-bottom: 1.5rem;
    padding-bottom: 1.25rem;
    border-bottom: 1px solid var(--border-light);
  }
  .ak { display: flex; flex-direction: column; }
  .ak-v {
    font-size: 1.35rem;
    font-weight: 700;
    font-family: var(--font-body);
    letter-spacing: -0.02em;
  }
  .ak-l {
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-muted);
    margin-top: 1px;
  }

  .analytics-charts {
    display: grid;
    grid-template-columns: 1.6fr 1fr;
    gap: 1.25rem;
  }
  .analytics-chart-main {
    position: relative;
    height: 240px;
  }
  .analytics-chart-side {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .analytics-chart-half {
    position: relative;
    height: 110px;
  }

  @media (max-width: 768px) {
    .cost-analytics { padding: 1.25rem; }
    .analytics-kpis { gap: 1rem; flex-wrap: wrap; }
    .analytics-charts { grid-template-columns: 1fr; }
    .analytics-chart-main { height: 200px; }
    .analytics-chart-half { height: 140px; }
    .analytics-header { flex-direction: column; gap: 0.5rem; }
  }
</style>
