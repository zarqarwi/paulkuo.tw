---
import CostTicker from '../components/CostTicker.astro';
import NavBar from '../components/layout/NavBar.astro';
import Footer from '../components/layout/Footer.astro';
import SchemaJsonLd from '../components/layout/SchemaJsonLd.astro';
import ReadingProgressBar from '../components/layout/ReadingProgressBar.astro';
import ReadingTracker from '../components/layout/ReadingTracker.astro';
import FocusMode from '../components/layout/FocusMode.astro';
import FontToggle from '../components/layout/FontToggle.astro';
import I18nClientSwitch from '../components/layout/I18nClientSwitch.astro';
import WebMCPTools from '../components/layout/WebMCPTools.astro';
import { createHash } from 'crypto';
import { readFileSync } from 'fs';
import {
  getLangFromPath,
  getLangPrefix,
  getBasePath,
  getHreflangs,
  getLangSwitchLinks,
} from '../utils/i18n';

// Content-based CSS cache busting (hash changes only when CSS content changes)
const cssHash = (file: string) =>
  createHash('md5').update(readFileSync(`public/styles/${file}`)).digest('hex').slice(0, 8);
const globalCssV = cssHash('global.css');
const cjkCssV = cssHash('cjk-fixes.css');

interface Props {
  title: string;
  description?: string;
  ogType?: string;
  ogUrl?: string;
  ogImage?: string;
  schemaJson?: string;
  canonicalUrl?: string;
  showTicker?: boolean;
}

const {
  title,
  description = '在技術與文明的交匯處，重建秩序、循環再利用、守護人性尊嚴。',
  ogType = 'website',
  ogUrl = 'https://paulkuo.tw',
  ogImage = 'https://paulkuo.tw/paul-photo.png',
  schemaJson,
  canonicalUrl,
  showTicker = false,
} = Astro.props;

const canonical = canonicalUrl || Astro.url.href.replace(/\/$/, '') || ogUrl;

// i18n
const pathname = Astro.url.pathname;
const currentLang = getLangFromPath(pathname);
const langPrefix = getLangPrefix(currentLang);
const basePath = getBasePath(pathname);
const hreflangs = getHreflangs(basePath);
const langSwitchLinks = getLangSwitchLinks(basePath);

const isArticlePage = pathname.includes('/articles/');
---

<!DOCTYPE html>
<html lang={currentLang}>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{title}</title>
  <meta name="description" content={description}>
  <meta name="author" content="Paul Kuo">
  <meta property="og:title" content={title}>
  <meta property="og:description" content={description}>
  <meta property="og:type" content={ogType}>
  <meta property="og:url" content={ogUrl}>
  <meta property="og:image" content={ogImage}>
  <meta property="og:locale" content={currentLang === 'zh-Hant' ? 'zh_TW' : currentLang === 'zh-CN' ? 'zh_CN' : currentLang === 'ja' ? 'ja_JP' : 'en_US'} />
  <meta property="og:site_name" content="Paul Kuo">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content={title}>
  <meta name="twitter:description" content={description}>
  <meta name="twitter:image" content={ogImage}>
  <meta name="twitter:site" content="@zarqarwi">
  <meta name="twitter:creator" content="@zarqarwi">
  <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1">
  <link rel="canonical" href={canonical}>
  {hreflangs.map(h => (
    <link rel="alternate" hreflang={h.lang} href={h.href} />
  ))}
  <link rel="alternate" type="application/rss+xml" title="Paul Kuo RSS Feed" href="/rss.xml">
  <link rel="icon" href="/favicon.ico" sizes="32x32">
  <link rel="icon" type="image/png" href="/favicon.png" sizes="192x192">
  <link rel="apple-touch-icon" href="/favicon.png">
  <link rel="manifest" href="/manifest.json">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=DM+Sans:ital,wght@0,400;0,500;0,700;1,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href={`/styles/global.css?v=${globalCssV}`}>
  <link rel="stylesheet" href={`/styles/cjk-fixes.css?v=${cjkCssV}`}>
  {schemaJson && <script type="application/ld+json" set:html={schemaJson} />}
  <SchemaJsonLd />
  <slot name="head" />
  <script src="/webmcp.js" defer></script>
</head>
<body>
  {isArticlePage && <ReadingProgressBar />}

  <NavBar langPrefix={langPrefix} currentLang={currentLang} langSwitchLinks={langSwitchLinks} />

  {showTicker && (
    <aside class="global-ticker" id="globalTicker" role="complementary" aria-label="即時資料" data-nosnippet>
      <CostTicker />
    </aside>
  )}

  <main>
    <slot />
  </main>

  <Footer />
  <WebMCPTools />
  <FontToggle />
  {isArticlePage && <FocusMode />}
  <ReadingTracker />
  <I18nClientSwitch />
</body>
</html>
