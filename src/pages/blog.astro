---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import { PILLAR_MAP } from '../config';

const ARTICLES_PER_PAGE = 12;

const articles = (await getCollection('articles', ({ data }) => !data.draft))
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const pillars = Object.entries(PILLAR_MAP);
---
<BaseLayout title="Thinking Out Loud — Paul Kuo" description="智能、再生、文明、創造、記憶 — 在實作中思考，在思考中前進。">
  <div class="section-container">
    <div class="blog-hero">
      <h1>Thinking Out Loud</h1>
      <p>智能、再生、文明、創造、記憶 — 在實作中思考，在思考中前進。</p>
    </div>

    <div class="blog-filters">
      <button class="filter-btn active" data-filter="all">全部</button>
      {pillars.map(([key, p]) => (
        <button class="filter-btn" data-filter={key}>{p.label}</button>
      ))}
    </div>

    <div class="content-grid" id="blog-grid">
      {articles.map((article, idx) => {
        const p = PILLAR_MAP[article.data.pillar];
        const isoDate = article.data.date.toISOString().split('T')[0];
        const dateStr = article.data.date.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit' });
        return (
          <a href={`/articles/${article.id.replace(/\.md$/, "")}`} 
             class={`content-card ${idx >= ARTICLES_PER_PAGE ? 'hidden-card' : ''}`} 
             data-pillar={article.data.pillar}>
            <div class="content-card-category" style={`color:${p.color}`}>
              <span class="pillar-dot" style={`background:${p.color}`}></span> {p.label}
            </div>
            <h3>{article.data.title}</h3>
            <p class="card-excerpt">{article.data.description}</p>
            <div class="content-card-footer">
              <time datetime={isoDate}>{dateStr}</time>
              {article.data.platform && <span class="platform-badge">{article.data.platform}</span>}
            </div>
          </a>
        );
      })}
    </div>

    {articles.length > ARTICLES_PER_PAGE && (
      <div class="load-more-wrap" id="load-more-wrap">
        <button class="load-more-btn" id="load-more-btn">
          顯示更多文章 <span id="remaining-count"></span>
        </button>
      </div>
    )}

    {articles.length === 0 && (
      <div style="text-align:center; padding:80px 0; color:var(--text-muted);">
        <p>旗艦文章即將上線。</p>
      </div>
    )}
  </div>

  <script define:vars={{ ARTICLES_PER_PAGE }}>
    let visibleCount = ARTICLES_PER_PAGE;
    const allCards = Array.from(document.querySelectorAll('#blog-grid .content-card'));
    const loadMoreBtn = document.getElementById('load-more-btn');
    const loadMoreWrap = document.getElementById('load-more-wrap');
    const remainingSpan = document.getElementById('remaining-count');

    function getFilteredCards() {
      const activeFilter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';
      return allCards.filter(c => activeFilter === 'all' || c.dataset.pillar === activeFilter);
    }

    function updateVisibility() {
      const filtered = getFilteredCards();
      filtered.forEach((card, i) => {
        card.style.display = i < visibleCount ? 'block' : 'none';
        card.classList.toggle('hidden-card', i >= visibleCount);
      });
      // Hide cards that don't match filter
      allCards.forEach(card => {
        const activeFilter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';
        if (activeFilter !== 'all' && card.dataset.pillar !== activeFilter) {
          card.style.display = 'none';
        }
      });
      // Update load more button
      const remaining = filtered.length - visibleCount;
      if (loadMoreWrap) {
        loadMoreWrap.style.display = remaining > 0 ? 'block' : 'none';
      }
      if (remainingSpan) {
        remainingSpan.textContent = remaining > 0 ? `(${remaining})` : '';
      }
    }

    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        visibleCount = ARTICLES_PER_PAGE;
        updateVisibility();
      });
    });

    // Load more
    if (loadMoreBtn) {
      loadMoreBtn.addEventListener('click', () => {
        visibleCount += ARTICLES_PER_PAGE;
        updateVisibility();
      });
    }

    // Initial
    updateVisibility();
  </script>
</BaseLayout>
