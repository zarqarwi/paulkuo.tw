---
import { getCollection } from 'astro:content';
import { render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { PILLAR_MAP, SITE } from '../../config';

export async function getStaticPaths() {
  const articles = await getCollection('articles', ({ data }) => !data.draft);
  return articles.map((article) => ({
    params: { slug: article.id.replace(/\.md$/, '') },
    props: { article },
  }));
}

const { article } = Astro.props;
const { Content } = await render(article);
const { title, subtitle, description, date, updated, pillar, tags, readingTime } = article.data;
const p = PILLAR_MAP[pillar];

const dateStr = date.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long' });

const schemaJson = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": title,
  "description": description,
  "datePublished": date.toISOString().split('T')[0],
  "dateModified": (updated || date).toISOString().split('T')[0],
  "inLanguage": "zh-Hant",
  "url": `${SITE.url}/articles/${article.id.replace(/\.md$/, '')}`,
  "author": {
    "@type": "Person",
    "name": SITE.author,
    "alternateName": SITE.authorAlt,
    "url": SITE.url,
    "description": SITE.description,
    "sameAs": [
      "https://www.linkedin.com/in/paulkuo",
      "https://x.com/paulkuo",
      "https://www.threads.net/@zarqarwi"
    ]
  },
  "publisher": { "@type": "Person", "name": SITE.author, "url": SITE.url },
  "mainEntityOfPage": { "@type": "WebPage", "@id": `${SITE.url}/articles/${article.id.replace(/\.md$/, '')}` },
  "keywords": tags
});
---
<BaseLayout 
  title={`${title} — Paul Kuo`} 
  description={description}
  ogType="article"
  ogUrl={`${SITE.url}/articles/${article.id}`}
  schemaJson={schemaJson}
>
  <article class="article-page">
    <a href="/blog" class="article-back">← 返回思想列表</a>
    
    <header class="article-meta">
      <div class="article-pillar" style={`color:${p.color}`}>
        <span class="pillar-dot" style={`background:${p.color}`}></span> {p.label}
      </div>
      <h1>{title}</h1>
      {subtitle && <p class="article-subtitle">{subtitle}</p>}
      <div class="article-info">
        <span>{SITE.author} {SITE.authorAlt}</span>
        <time datetime={date.toISOString().split('T')[0]}>{dateStr}</time>
        {readingTime && <span>閱讀時間約 {readingTime} 分鐘</span>}
      </div>
    </header>

    <div class="article-body">
      <Content />
    </div>

    {tags.length > 0 && (
      <div class="article-tags">
        {tags.map(tag => <span class="article-tag">{tag}</span>)}
      </div>
    )}

    <nav class="article-nav-bottom">
      <a href="/blog">← 返回思想列表</a>
    </nav>
  </article>
</BaseLayout>
